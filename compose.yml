services:
  discord-bot:
    build: .
    container_name: ellensings-bot
    restart: unless-stopped

    # NET_ADMIN нужен для tun2socks (создание TUN интерфейса)
    cap_add:
      - NET_ADMIN

    # Доступ к TUN устройству для tun2socks
    devices:
      - /dev/net/tun:/dev/net/tun

    # Доступ к хосту для подключения к signbox
    extra_hosts:
      - "host.docker.internal:host-gateway"

    # Переменные окружения
    environment:
      - TZ=Europe/Moscow
      - DISCORD_TOKEN=${DISCORD_TOKEN}
      # SOCKS proxy для tun2socks (весь трафик TCP+UDP)
      # host.docker.internal указывает на хост из контейнера
      - SOCKS_PROXY=${PROXY_URL}

    # Volumes
    volumes:
      - ./sounds:/app/sounds:ro
      # .env файл пробрасываем для удобства разработки
      - ./.env:/app/.env:ro

    # Логирование
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    # Health check
    healthcheck:
      test: ["CMD", "pgrep", "-f", "python.*bot.py"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
