services:
  discord-bot:
    build: .
    container_name: ellensings-bot
    restart: unless-stopped

    # Host network mode - контейнер в сети хоста
    # Позволяет tun2socks подключаться к signbox на 127.0.0.1
    network_mode: host

    # NET_ADMIN нужен для tun2socks (создание TUN интерфейса)
    cap_add:
      - NET_ADMIN

    # Переменные окружения
    environment:
      - TZ=Europe/Moscow
      - DISCORD_TOKEN=${DISCORD_TOKEN}
      # SOCKS proxy для tun2socks (весь трафик TCP+UDP)
      # В host mode можно использовать localhost
      - SOCKS_PROXY=${SOCKS_PROXY:-socks5://127.0.0.1:2080}

    # Volumes
    volumes:
      - ./sounds:/app/sounds:ro
      # .env файл пробрасываем для удобства разработки
      - ./.env:/app/.env:ro

    # Логирование
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    # Health check
    healthcheck:
      test: ["CMD", "pgrep", "-f", "python.*bot.py"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
